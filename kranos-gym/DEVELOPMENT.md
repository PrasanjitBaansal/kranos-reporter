# Development Guide

## Overview

Kranos Gym Management System development guide covering project structure, coding standards, development workflow, and best practices.

## Technology Stack

### Core Technologies
- **Frontend**: SvelteKit 2.16.0 with Svelte 5.0.0
- **Database**: SQLite3 with better-sqlite3 (12.0.0)
- **Build Tool**: Vite 6.2.6
- **Styling**: Custom CSS with CSS Variables
- **Package Manager**: npm

### Development Dependencies
- **Testing**: Vitest (unit) + Playwright (E2E)
- **Component Testing**: @testing-library/svelte
- **Database**: sqlite3 + better-sqlite3
- **Data Processing**: XLSX (0.18.5)

## Project Structure

```
kranos-gym/
├── src/
│   ├── lib/
│   │   ├── components/          # Reusable Svelte components
│   │   │   ├── MemberDetailsModal.svelte
│   │   │   ├── Modal.svelte
│   │   │   └── PasswordModal.svelte
│   │   ├── db/                  # Database layer
│   │   │   ├── database.js      # Database class with CRUD operations
│   │   │   ├── migrate.js       # Excel migration system
│   │   │   └── schema.sql       # Database schema definition
│   │   └── stores/              # Svelte stores
│   │       └── toast.js         # Toast notification system
│   ├── routes/                  # SvelteKit routes
│   │   ├── +layout.server.js    # Global settings loader
│   │   ├── +layout.svelte       # Main layout with navigation
│   │   ├── +page.server.js      # Dashboard server functions
│   │   ├── +page.svelte         # Dashboard component
│   │   ├── api/                 # API endpoints
│   │   │   └── members/[id]/memberships/+server.js
│   │   ├── members/             # Member management
│   │   │   ├── +page.server.js
│   │   │   └── +page.svelte
│   │   ├── plans/               # Group plans management
│   │   ├── memberships/         # Membership management
│   │   ├── reporting/           # Reports and analytics
│   │   └── settings/            # Admin settings
│   ├── test/                    # Test utilities and unit tests
│   ├── app.css                  # Global styles and theme system
│   └── app.html                 # HTML template
├── static/                      # Static assets
│   ├── uploads/                 # User uploads (favicon, logo)
│   └── data/                    # Excel migration files
├── tests/e2e/                   # End-to-end tests
├── scripts/                     # Build and utility scripts
├── run-app.sh                   # Unix/Mac startup script
├── run-app.bat                  # Windows startup script
└── kranos.db                    # SQLite database file
```

## Coding Standards

### JavaScript Conventions

**Naming Conventions** (as implemented in codebase):
```javascript
// Variables and functions: camelCase
const selectedMember = null;
let isLoading = false;
function validateForm(formData) {}
function closeModal() {}

// Classes: PascalCase
class Database {}

// Constants: UPPER_SNAKE_CASE
const DB_PATH = path.join(__dirname, '../../../kranos.db');

// Files: kebab-case for routes, PascalCase for components
// +page.svelte, +page.server.js
// Modal.svelte, MemberDetailsModal.svelte
```

**Svelte-Specific Conventions**:
```javascript
// Reactive variables: camelCase with descriptive names
$: filteredMembers = members.filter(member => ...);
$: autoGeneratedDisplayName = generateDisplayName(currentName, currentDuration);

// Event handlers: handle prefix
function handleRowClick(event, member) {}
function handleSubmit() {}

// Store usage: camelCase imports
import { showSuccess, showError } from '$lib/stores/toast.js';
```

**Function Standards** (actual implementation patterns):
```javascript
// SvelteKit server actions with consistent error handling
export const actions = {
    create: async ({ request }) => {
        const db = new Database();
        const data = await request.formData();
        
        try {
            await db.connect();
            const result = await db.createMember(memberData);
            return { success: true, member: result };
        } catch (error) {
            return { success: false, error: error.message };
        } finally {
            await db.close();
        }
    }
};

// Consistent response objects (as used in codebase)
// Success: { success: true, data?, member?, plan?, message? }
// Error: { success: false, error: string }
// File uploads: { success: true, message: string, file_path?: string }
```

**Validation Functions**:
```javascript
// Client-side validation pattern (used in all forms)
function validateForm(formData) {
    const errors = {};
    
    const name = formData.get('name');
    if (!name || !/^[a-zA-Z0-9\s]+$/.test(name.trim())) {
        errors.name = 'Name can only contain letters, numbers, and spaces';
    }
    
    return errors;
}

// Form submission with validation
const submitForm = () => {
    return async ({ formData, result }) => {
        const errors = validateForm(formData);
        if (Object.keys(errors).length > 0) {
            formErrors = errors;
            return;
        }
        
        isLoading = true;
        formErrors = {};
        // Handle result...
    };
};
```

### Database Standards

**Query Patterns**:
```javascript
// Parameterized queries (prevent SQL injection)
const query = 'SELECT * FROM members WHERE id = ?';
db.get(query, [id]);

// Descriptive aliases for joins
const query = `
    SELECT gcm.id, gcm.start_date, m.name as member_name
    FROM group_class_memberships gcm
    JOIN members m ON gcm.member_id = m.id
    WHERE gcm.status = ?
`;
```

**Connection Management**:
```javascript
// Singleton pattern with proper cleanup
class Database {
    async connect() { /* connection logic */ }
    async close() { /* cleanup logic */ }
    async ensureConnection() { /* lazy connection */ }
}
```

### CSS Standards

**CSS Variables Pattern**:
```css
:root {
    /* Theme Colors */
    --primary: #f39407;
    --primary-dark: #d17900;
    --primary-light: #ffb347;
    
    /* Background System */
    --bg-primary: #000000;
    --bg-secondary: #111111;
    --bg-tertiary: #1a1a1a;
    
    /* Text Colors */
    --text-primary: #ffffff;
    --text-secondary: #cccccc;
    --text-muted: #888888;
}
```

**Component CSS Pattern**:
```css
/* Component-scoped styles */
.component-container {
    /* Layout */
    display: flex;
    flex-direction: column;
    
    /* Theme integration */
    background: var(--bg-secondary);
    color: var(--text-primary);
    
    /* Responsive design */
    padding: 1rem;
}

@media (max-width: 768px) {
    .component-container {
        padding: 0.5rem;
    }
}
```

## Form Validation Architecture

### Validation Strategy
- **NO HTML5 validation**: All forms use `novalidate` attribute
- **Custom JavaScript only**: Consistent validation experience
- **Real-time error clearing**: Errors disappear when user corrects input
- **Client-side pre-validation**: Runs before SvelteKit's `use:enhance`

### Validation Pattern
```javascript
// Standard validation function
function validateForm(formData) {
    const errors = {};
    
    // Required field validation
    const name = formData.get('name');
    if (!name || !name.trim()) {
        errors.name = 'Name is required';
    }
    
    // Phone validation (exactly 10 digits)
    const phone = formData.get('phone');
    if (!phone || !/^\d{10}$/.test(phone)) {
        errors.phone = 'Phone number must be exactly 10 digits';
    }
    
    // Email validation (optional)
    const email = formData.get('email');
    if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.trim())) {
        errors.email = 'Please enter a valid email address';
    }
    
    return errors;
}

// Form submission with validation
const submitForm = () => {
    return async ({ formData, result }) => {
        // Client-side validation
        const errors = validateForm(formData);
        if (Object.keys(errors).length > 0) {
            formErrors = errors;
            return;
        }
        
        // Proceed with submission
        isLoading = true;
        formErrors = {};
        // Handle result...
    };
};
```

### Error Display Pattern
```svelte
<!-- Form with validation -->
<form method="POST" action="?/create" use:enhance={submitForm} novalidate>
    <input
        class="form-control"
        class:error={formErrors.name}
        name="name"
        placeholder="Enter member name"
        on:input={() => {
            if (formErrors.name) {
                formErrors = { ...formErrors, name: '' };
            }
        }}
    />
    {#if formErrors.name}
        <span class="error-message">{formErrors.name}</span>
    {/if}
</form>

<style>
.form-control.error {
    border-color: #ff4444;
    box-shadow: 0 0 0 2px rgba(255, 68, 68, 0.2);
}

.error-message {
    color: #ff4444;
    font-size: 0.875rem;
    margin-top: 0.25rem;
}
</style>
```

## Component Development

### Component Architecture (actual patterns used)
```svelte
<script>
    // Standard imports pattern
    import { enhance } from '$app/forms';
    import { invalidateAll } from '$app/navigation';
    import { showSuccess, showError } from '$lib/stores/toast.js';
    import Modal from '$lib/components/Modal.svelte';
    
    // Props (data from server, form for form actions)
    export let data;
    export let form;
    
    // Local state with descriptive names
    let selectedMember = null;
    let isEditing = false;
    let isLoading = false;
    let showModal = false;
    let formErrors = {};
    let searchTerm = '';
    
    // Reactive statements for computed values
    $: members = data.members || [];
    $: filteredMembers = members.filter(member => {
        // Filtering logic
        return member.name.toLowerCase().includes(searchTerm.toLowerCase());
    });
    
    // Functions with clear names and purposes
    function editMember(member) {
        selectedMember = member;
        isEditing = true;
        formErrors = {};
        showModal = true;
    }
    
    function closeModal() {
        showModal = false;
        selectedMember = null;
        isEditing = false;
        formErrors = {};
    }
</script>

<!-- Template with semantic structure -->
<div class="page-container">
    <!-- Page content -->
</div>

<!-- Modal components -->
{#if showModal}
    <Modal on:close={closeModal}>
        <!-- Modal content -->
    </Modal>
{/if}

<style>
    /* Component-scoped styles with CSS variables */
    .page-container {
        background: var(--bg-primary);
        color: var(--text-primary);
    }
</style>
```

### Store Pattern (actual implementation)
```javascript
// stores/toast.js - Advanced toast system with animations
import { writable } from 'svelte/store';

function createToastStore() {
    const { subscribe, set, update } = writable([]);
    
    return {
        subscribe,
        add: (toast) => {
            const id = Date.now() + Math.random();
            const newToast = {
                id,
                type: toast.type || 'info',
                message: toast.message,
                duration: toast.duration || 4000,
                entering: true,
                exiting: false
            };
            
            update(toasts => [...toasts, newToast]);
            
            // Auto-remove with animation states
            setTimeout(() => {
                update(toasts => 
                    toasts.map(t => 
                        t.id === id ? { ...t, entering: false, exiting: true } : t
                    )
                );
                
                setTimeout(() => {
                    update(toasts => toasts.filter(t => t.id !== id));
                }, 300); // Animation duration
            }, newToast.duration);
            
            return id;
        },
        // Convenience methods for different toast types
        success: (message, duration) => {
            return toastStore.add({ type: 'success', message, duration });
        },
        error: (message, duration) => {
            return toastStore.add({ type: 'error', message, duration });
        }
    };
}

export const toastStore = createToastStore();

// Convenience exports for easy importing
export const showSuccess = (message, duration) => toastStore.success(message, duration);
export const showError = (message, duration) => toastStore.error(message, duration);
```

## SvelteKit Patterns

### Server Functions
```javascript
// +page.server.js
export const load = async () => {
    const db = new Database();
    try {
        await db.connect();
        const data = await db.getData();
        return { data };
    } catch (error) {
        console.error('Load error:', error);
        return { data: [] };
    } finally {
        await db.close();
    }
};

export const actions = {
    create: async ({ request }) => {
        const formData = await request.formData();
        const data = {
            field1: formData.get('field1'),
            field2: formData.get('field2')
        };
        
        // Process data...
        return { success: true, data };
    }
};
```

### Form Enhancement (actual implementation pattern)
```svelte
<script>
    import { enhance } from '$app/forms';
    import { invalidateAll } from '$app/navigation';
    import { showSuccess, showError } from '$lib/stores/toast.js';
    
    let isLoading = false;
    let formErrors = {};
    
    // Client-side validation before submission
    const submitForm = () => {
        return async ({ formData, result }) => {
            // Client-side validation
            const errors = validateForm(formData);
            if (Object.keys(errors).length > 0) {
                formErrors = errors;
                return;
            }
            
            isLoading = true;
            formErrors = {};
            
            // Handle server response
            if (result.type === 'success') {
                if (result.data?.success === false) {
                    // Server-side validation failed
                    if (result.data.error?.includes('Phone number')) {
                        formErrors = { phone: result.data.error };
                    } else {
                        formErrors = { general: result.data.error };
                    }
                } else {
                    // Success - show message, close modal, refresh data
                    showSuccess(isEditing ? 'Member updated successfully!' : 'Member created successfully!');
                    closeModal();
                    await invalidateAll(); // Refresh page data
                }
            } else {
                showError('An error occurred. Please try again.');
            }
            
            isLoading = false;
        };
    };
</script>

<!-- Form with novalidate for custom validation -->
<form method="POST" action="?/create" use:enhance={submitForm} novalidate>
    <input
        class="form-control"
        class:error={formErrors.name}
        name="name"
        placeholder="Enter member name"
        on:input={() => {
            if (formErrors.name) {
                formErrors = { ...formErrors, name: '' };
            }
        }}
    />
    {#if formErrors.name}
        <span class="error-message">{formErrors.name}</span>
    {/if}
</form>
```

## Development Workflow

### Setup Process
```bash
# 1. Install dependencies
npm install

# 2. Initialize database (if needed)
node src/lib/db/migrate.js

# 3. Start development server
npm run dev
# or use convenience scripts:
# Unix/Mac: ./run-app.sh
# Windows: run-app.bat
```

### Available Scripts
```json
{
  "dev": "vite dev",                    // Development server
  "build": "vite build",                // Production build
  "preview": "vite preview",            // Preview build
  "test": "vitest",                     // Unit tests
  "test:watch": "vitest --watch",       // Watch mode
  "test:coverage": "vitest --coverage", // Coverage report
  "test:e2e": "playwright test",        // E2E tests
  "test:all": "npm run test && npm run test:e2e"
}
```

### File Conventions
- **Routes**: Use SvelteKit file-based routing
- **Components**: PascalCase with .svelte extension
- **Utilities**: camelCase with .js extension
- **Tests**: Same name with .test.js or .spec.js
- **Styles**: Global in app.css, component styles in <style> blocks

## Theme System

### CSS Variable Architecture
```css
/* Theme switching via data attributes */
[data-theme="dark"] {
    --bg-primary: #000000;
    --text-primary: #ffffff;
}

[data-theme="light"] {
    --bg-primary: #ffffff;
    --text-primary: #000000;
}

/* Dynamic color generation */
:root {
    --primary: #f39407;
    --primary-dark: color-mix(in srgb, var(--primary) 80%, black);
    --primary-light: color-mix(in srgb, var(--primary) 80%, white);
}
```

### Theme Application
```javascript
// Layout server loads settings
export async function load() {
    return { appSettings: getAppSettings() };
}

// Theme application in layout
function applyAppSettings() {
    const theme = appSettings.theme_mode || 'dark';
    document.documentElement.setAttribute('data-theme', theme);
    
    const color = appSettings.accent_color || '#f39407';
    document.documentElement.style.setProperty('--primary', color);
}
```

## Testing Strategy

### Unit Tests
```javascript
// Component testing
import { render, screen } from '@testing-library/svelte/svelte5';
import { expect, test } from 'vitest';
import Component from './Component.svelte';

test('renders component correctly', () => {
    render(Component, { props: { data: mockData } });
    expect(screen.getByText('Expected Text')).toBeInTheDocument();
});
```

### E2E Tests
```javascript
// Complete user workflows
import { test, expect } from '@playwright/test';

test('member management workflow', async ({ page }) => {
    await page.goto('/members');
    await page.getByRole('button', { name: 'Add New Member' }).click();
    // Continue workflow...
});
```

## Performance Guidelines

### Database Optimization
- Use prepared statements for repeated queries
- Implement proper connection management
- Index frequently queried columns
- Use JOIN queries for related data

### Frontend Optimization
- Lazy load components when possible
- Use CSS variables for theme switching
- Implement proper loading states
- Optimize bundle size with tree shaking

### Asset Management
- Compress images before upload
- Use appropriate file formats
- Implement file size limits
- Clean up old uploaded files

## Security Best Practices

### Input Validation
```javascript
// Server-side validation
function validateInput(data) {
    // Sanitize and validate all inputs
    return cleanData;
}

// SQL injection prevention
db.get('SELECT * FROM table WHERE id = ?', [id]);
```

### File Upload Security
```javascript
// File validation
if (!file.type.startsWith('image/png')) {
    return fail(400, { error: 'Invalid file type' });
}

if (file.size > MAX_SIZE) {
    return fail(400, { error: 'File too large' });
}
```

### Settings Protection
```javascript
// Password-protected admin areas
if (password !== 'theadmin') {
    return fail(401, { error: 'Invalid password' });
}
```

## Error Handling

### Consistent Error Patterns
```javascript
// Database errors
try {
    const result = await db.operation();
    return { success: true, data: result };
} catch (error) {
    console.error('Database error:', error.message);
    return { success: false, error: 'Operation failed' };
}

// Form validation errors
const errors = validateForm(formData);
if (Object.keys(errors).length > 0) {
    formErrors = errors;
    return;
}
```

### User-Friendly Messages
```javascript
// Convert technical errors to user messages
function getUserMessage(error) {
    if (error.code === 'SQLITE_CONSTRAINT_UNIQUE') {
        return 'This phone number already exists';
    }
    return 'An unexpected error occurred';
}
```

## Deployment Considerations

### Build Process
```bash
# Production build
npm run build

# Test build locally
npm run preview
```

### Environment Setup
- Node.js 18+ required
- SQLite3 database file
- Write permissions for uploads directory
- Environment variables for production settings

### Database Migration
- Backup existing database before updates
- Test migration process in development
- Validate data integrity after migration
- Document schema changes

## Contributing Guidelines

### Code Quality
1. Follow established patterns and conventions
2. Add tests for new functionality
3. Update documentation for changes
4. Use consistent error handling
5. Validate all user inputs

### Git Workflow
```bash
# Feature development
git checkout -b feature/feature-name
# Make changes...
git commit -m "Add feature description"
git push origin feature/feature-name
# Create pull request
```

### Code Review Checklist
- [ ] Follows coding standards
- [ ] Includes appropriate tests
- [ ] Updates documentation
- [ ] Handles errors properly
- [ ] Validates security implications
- [ ] Considers performance impact